<html>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<script>

var c;
var ctx;
var fps = 30;

//image loading
var spaceshipPic = document.createElement("img");
var spaceshipPicLoaded = false;
var alienShipPic = document.createElement("img");
var alienShipPicLoaded = false;
var shieldPic = document.createElement("img");
var shieldPicLoaded = false;

//Game Scenes
const GAME_SCREEN = 0;
const WIN_SCREEN = 1;
const GAME_OVER = 2;
const TITLE_SCREEN = 3;
const MAIN_MENU = 4;
const CREDIT_SCREEN = 5;
var mode = TITLE_SCREEN;

//player ship variables
var spaceShipPosX = 380;
var spaceShipPosY = 460;
const PLAYER_SHIP_WIDTH = 60; //current width of pixel art
const PLAYER_SHIP_HEIGHT = 80; //current height of pixel art 
var speedBuffer = false;

var shield01 = true;
var playerScore = 0;
const WIN_SCORE = 1;


const KEY_LEFT_ARROW = 37;
const KEY_UP_ARROW = 38;
const KEY_RIGHT_ARROW = 39;
const KEY_DOWN_ARROW = 40;
const KEY_BACKSPACE = 32;
const KEY_Q = 81;
const KEY_S = 83;

var shotActive = false;
var shotY;
var shotY;
const PLAYER_SHOT_SPEED = 10;

//alien variables
var alienPosX = 100;
var alienPosY = 100;
var alienSpeedX = 4;
const ALINE_WIDTH = 100;
const ALIEN_HEIGHT = 30;
var alienDestroyed = false;
var respawnTimer = 0;
var alienColor = 'green';
var alienShotActive = false;
var alienShotX;
var alienShotY;
const ALIEN_SHOT_SPEED = 10;

var angle = 0;


var screenBuffer = 20;


	setInterval (function() {
		drawEverything(),
		moveEverything()},
		1000/fps);

	document.addEventListener('keydown', keyPressed);
	document.addEventListener('keyup', keyReleased);
	
	window.onload = function () {
		drawEverything();
		moveEverything();	

		spaceshipPic.onload = function() {
			spaceshipPicLoaded = true;
			alienShipPicLoaded = true;
			shieldPicLoaded = true;
		}
		spaceshipPic.src = "PlayerShip.png";
		alienShipPic.src = "AlienShip.png";
		shieldPic.src = "Shield.png";
	}

function drawEverything() {

	//canvas
	c = document.getElementById ('gameCanvas');
	ctx = c.getContext ('2d');
	ctx.fillStyle = 'black';
	ctx.fillRect (0, 0, c.width, c.height);

	//game screen
	if(mode == GAME_SCREEN){
		gameMode();
		}

	//win screen
	if(mode == WIN_SCREEN) {
		winScreen();
		}

	//game over screen
	if(mode == GAME_OVER) {
		gameOverScreen();
		}

	//title screen
	if(mode == TITLE_SCREEN) {
		titleScreen();
	}

	//main menu
	if(mode == MAIN_MENU) {
		mainMenuScreen();
	}
	
	//credits
	if(mode == CREDIT_SCREEN) {
		creditScreen();
	}

}

function moveEverything() {
	moveShot();
	moveAlien();
	spaceshipAutoReverse();
	angle += .01;
}
//======================================================================
//scene function

function gameMode() {

	//player shot
	if(shotActive) {
		colorCircle(shotX, shotY, 3, 'white'); 
		//colorRect(shotX, shotY, 4, 10,'white');
	}

	//alien
	if(alienDestroyed == false) {
		ctx.drawImage(alienShipPic, alienPosX, alienPosY);
		//colorRect(alienPosX, alienPosY, ALINE_WIDTH, ALIEN_HEIGHT, alienColor);
	}

	if(alienShotActive) {
		colorRect(alienShotX, alienShotY, 4, 10, 'white');
	}

	//space ship
	if(spaceshipPicLoaded){
		ctx.drawImage(spaceshipPic, spaceShipPosX, spaceShipPosY);
	}

	//ship shield
	if(shield01) {
		drawBitmapCenteredAtLocationWithRotation(shieldPic, spaceShipPosX + PLAYER_SHIP_WIDTH/2, spaceShipPosY + PLAYER_SHIP_HEIGHT/2, angle);
		//colorEmptyCircle(spaceShipPosX + PLAYER_SHIP_WIDTH/2, spaceShipPosY + PLAYER_SHIP_HEIGHT/2, 55, 'white');
	}
	
	//player score
	colorText("Score: " + playerScore, 700, 560, "15px arial", "white");

	respawnAlien();

}

function gameOverScreen() {
	colorRect(0, 0, c.width, c.height, 'blue');
	colorText("Game Over", c.width/2 - 80, c.height/2, "30px arial", "white");
	colorText("New Game: [SPACE]", 330, 350, "15px arial", "white");
}

function winScreen() {
	colorRect(0, 0, c.width, c.height, 'green');
	colorText("Player Wins", c.width/2 - 80, c.height/2, "30px arial", "white");
	colorText("New Game: [SPACE]", 330, 350, "15px arial", "white");
}

function titleScreen() {
	colorRect(0, 0, c.width, c.height, 'red');
	colorText("Title Screen", c.width/2 - 80, c.height/2, "30px arial", "white");
	colorText("New Game: [SPACE]", 330, 350, "15px arial", "white");
}

function mainMenuScreen() {
	colorRect(0, 0, c.width, c.height, 'orange');
	colorText("Main Menu", c.width/2 - 80, c.height/2, "30px arial", "white");
	colorText("New Game: [SPACE]", 330, 350, "15px arial", "white");
}

function creditScreen() {
	colorRect(0, 0, c.width, c.height, 'black');
	colorText("Credits", c.width/2 - 80, c.height/2, "30px arial", "white");
	colorText("New Game: [SPACE]", 330, 350, "15px arial", "white");
}

//======================================================================

//input handling

function keyPressed(evt) {
	if(mode == GAME_SCREEN){
		//console.log("Key pressed: " + evt.keyCode);
		if (evt.keyCode == KEY_LEFT_ARROW) {
			if(spaceShipPosX >= 20) {
				spaceShipPosX -= 10;
			}
		}

		if (evt.keyCode == KEY_RIGHT_ARROW) {
			if(spaceShipPosX <= c.width - PLAYER_SHIP_WIDTH - 20) {
				spaceShipPosX += 10;
			}
		}

		if (evt.keyCode == KEY_UP_ARROW) {
			speedBuffer = false;
			if(spaceShipPosY >= 20){
				spaceShipPosY -= 5;
			}	
		}

		if (evt.keyCode == KEY_DOWN_ARROW) {
			if(spaceShipPosY <= 495){
				spaceShipPosY += 5;
			}
		}

		if(evt.keyCode == KEY_UP_ARROW && evt.keyCode == KEY_RIGHT_ARROW){
			speedBuffer = false;
			if(spaceShipPosY >= 20){
				spaceShipPosY -= 5;
			}
			if(spaceShipPosX <= c.width - PLAYER_SHIP_WIDTH - 20) {
				spaceShipPosX += 10;
			}

		}

		if(evt.keyCode == KEY_BACKSPACE) {
			playerReload();
		}

		//cheat keys

		if(evt.keyCode == KEY_Q) {
			console.log("alien shot");
			alienReload();
		}

		if(evt.keyCode == KEY_S) {
			shield01 = !shield01;
		}

	}

	if(mode == TITLE_SCREEN) {
		if(evt.keyCode == KEY_BACKSPACE) {
			mode = MAIN_MENU;
		}
	}

	if(mode != GAME_SCREEN && mode != TITLE_SCREEN) {
		if(evt.keyCode == KEY_BACKSPACE) {
			mode = GAME_SCREEN;
			playerScore = 0;
			spaceShipPosX = 400;
			spaceShipPosY = 500;
		}
	}


	evt.preventDefault(); // this is to prevent arrow keys from scrolling the page.
}


function keyReleased(evt) {
	//console.log("Key released: " + evt.keyCode);
	if(evt.keyCode == KEY_UP_ARROW) {
		speedBuffer = true;
	}
}

//======================================================================

function spaceshipAutoReverse() {
	if(spaceShipPosY <= 495 && speedBuffer){
		spaceShipPosY += 1;
	}
}

function playerReload() {
	if(shotActive == false) {
		shotX = spaceShipPosX + 30;
		shotY = spaceShipPosY;
		shotActive = true;
	}
}

function alienReload(){
	if(alienShotActive == false) {
		alienShotX = alienPosX + ALINE_WIDTH/2;
		alienShotY = alienPosY + ALIEN_HEIGHT;
		alienShotActive = true;
	}
}

function moveShot() {
	if(shotActive) {
		shotY -= PLAYER_SHOT_SPEED;
		playerShotCheck();
	}
	if(alienShotActive){
		alienShotY += ALIEN_SHOT_SPEED;
		alienShotCheck();
	}
}

function playerShotCheck() {
	if(shotY <= alienPosY + ALIEN_HEIGHT && shotX >= alienPosX && shotX <= alienPosX + ALINE_WIDTH) {
		shotActive = false;
		console.log("alien destroyed");
		alienDestroyed = true;
		playerScoring();
	}
	if(shotY < 0) {
		shotActive = false;
	}
}

function alienShotCheck() {
	if(shield01 && alienShotY >= spaceShipPosY - 20 && alienShotX >= spaceShipPosX - 20 && alienShotX <= spaceShipPosX + PLAYER_SHIP_WIDTH + 20){
		shield01 = false;
		alienShotActive = false;
	}

	if(alienShotY >= spaceShipPosY && alienShotX >= spaceShipPosX && alienShotX <= spaceShipPosX + PLAYER_SHIP_WIDTH){
		alienShotActive = false;
		console.log("player destroyed");
		playerLose();
	}
	if(alienShotY >= c.height) {
		alienShotActive = false;
	}
}

function moveAlien() {
	alienPosX = alienPosX - alienSpeedX;
	
	if(alienPosX > c.width - ALINE_WIDTH - screenBuffer) {
		alienSpeedX = -alienSpeedX;
	}
	
	if(alienPosX < 0 + screenBuffer) {
		alienSpeedX = -alienSpeedX;
	}
}

function respawnAlien() {
	colorAlien();
	if(alienDestroyed == true){
		respawnTimer++;
		if(respawnTimer >= 60) {
			alienDestroyed = false;
			respawnTimer = 0;
		}
	}
}

function colorAlien() {
	if(playerScore == 0){
		alienColor = 'green';
	}
	if(playerScore == 1){
		alienColor = 'blue';
	}
	if(playerScore == 2){
		alienColor = 'red';

	}
}

function playerScoring() {
	playerScore ++;
	
	if(playerScore >= WIN_SCORE){
		mode = WIN_SCREEN;
	}
}

function playerLose() {
	mode = GAME_OVER;
}


// =========================================================================
//Common Graphics Functions
function colorRect(topLeftX, topLeftY, boxWidth, boxHeight, fillColor) {
	ctx.fillStyle = fillColor;
	ctx.fillRect(topLeftX, topLeftY, boxWidth, boxHeight);
}

function colorCircle(centerX, centerY, radius, fillColor) {
    ctx.fillStyle = fillColor;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI*2, true);
    ctx.fill();
}

function colorEmptyCircle(centerX, centerY, radius, strokeColor) {
	ctx.beginPath();
	ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
	ctx.strokeStyle = strokeColor;
	ctx.stroke();
}

function colorText(text, posX, posY, font, color) {
	ctx.fillStyle = color;
	ctx.font = font;
	ctx.fillText (text, posX, posY);
}

function colorLine(startX, startY, endX, endY, lineWidth, fillColor) {
	ctx.strokeStyle = fillColor;
	ctx.lineWidth = lineWidth;
	ctx.beginPath();
	ctx.moveTo(startX, startY);
	ctx.lineTo(endX, endY);
	ctx.stroke();
}

function drawBitmapCenteredAtLocationWithRotation(graphic, atX, atY,withAngle) {
	ctx.save(); // allows us to undo translate movement and rotate spin
	ctx.translate(atX,atY); // sets the point where our graphic will go
	ctx.rotate(withAngle); // sets the rotation
	ctx.drawImage(graphic,-graphic.width/2,-graphic.height/2); // center, draw
	ctx.restore(); // undo the translation movement and rotation since save()
}

</script>
</html>